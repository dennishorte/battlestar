#!/bin/sh

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if api folder has changes
if echo "$STAGED_FILES" | grep -q "^api/"; then
  cd api

  echo "Running lint for api..."
  npm run lint

  echo "Running tests for api..."
  npm run test

  cd ..
fi

# Check if app folder has changes
if echo "$STAGED_FILES" | grep -q "^app/"; then
  cd app

  echo "Running lint:fix for app..."
  npm run lint:fix
  cd ..
  git add -u app/
fi

# Check if common folder has changes
if echo "$STAGED_FILES" | grep -q "^common/"; then
  cd common

  echo "Running lint:fix for common..."
  npm run lint:fix
  cd ..
  git add -u common/

  cd common

  # Determine which sub-projects need testing.
  # Changes in lib/ or root-level files trigger all tests.
  COMMON_FILES=$(echo "$STAGED_FILES" | grep "^common/" | sed 's|^common/||')

  if echo "$COMMON_FILES" | grep -qE "^(lib/|[^/]+$)"; then
    echo "Running all tests for common (shared code changed)..."
    npx jest
  else
    TEST_PATHS=""
    for dir in agricola magic tyrants ultimate; do
      if echo "$COMMON_FILES" | grep -q "^${dir}/"; then
        TEST_PATHS="$TEST_PATHS $dir/"
      fi
    done

    if [ -n "$TEST_PATHS" ]; then
      echo "Running tests for:$TEST_PATHS"
      npx jest $TEST_PATHS
    fi
  fi

  cd ..
fi
